{% extends "layout.html" %}
{% block title %}{{ lehrveranstaltung.name }}{% endblock %}
{% block content %}

    <h2>{{ lehrveranstaltung.name }} Uploads</h2>
    <div>
        {% for upload in uploads %}
            <article>
                <a href="{{ url_for('upload_detail', encoded_name=lehrveranstaltung.encoded_name, upload_id=upload.id) }}">{{ upload.filename }}</a>
                <p>Uploaded by: {{ upload.uploaded_by }} on {{ upload.upload_date }}</p>
                <p>Likes: <span id="likes-{{ upload.id }}">{{ upload.likes }}</span></p>
                <button onclick="likeUpload({{ upload.id }})">Like</button>
                <p>DEBUGGING: Upload_id = {{upload.id}}</p>
            </article>
        {% endfor %}
    </div>
    <h2>Upload a new file</h2>
    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        {{ form.file.label }} {{ form.file() }}
        {{ form.submit() }}
    </form>

    <script>
    function likeUpload(uploadId) {
        fetch(`/like/${uploadId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ form.csrf_token._value() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`likes-${uploadId}`).innerText = data.likes;
            } else {
                alert(data.message);
            }
        });
    }
    </script>

{% endblock %}
